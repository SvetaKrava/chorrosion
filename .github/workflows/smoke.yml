name: CI Smoke

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ "**" ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  smoke:
    name: Smoke (build, lint, test, run)
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Install chromaprint and FFmpeg (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Install LLVM using winget (recommended)
          # If winget fails, use choco as fallback
          try {
            winget install --id llvm.llvm -e --source winget --accept-source-agreements --accept-package-agreements
          } catch {
            choco install llvm -y
          }

          vcpkg install chromaprint:x64-windows
          vcpkg install ffmpeg[avcodec,avdevice,avformat,avfilter,swresample,swscale]:x64-windows

          $vcpkgExe = (Get-Command vcpkg -ErrorAction Stop).Source
          $vcpkgRoot = Split-Path -Parent $vcpkgExe
          $vcpkgInstalled = Join-Path $vcpkgRoot "installed\x64-windows"

          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV
          echo "VCPKG_ROOT=$vcpkgRoot" >> $env:GITHUB_ENV
          echo "VCPKG_DEFAULT_TRIPLET=x64-windows" >> $env:GITHUB_ENV
          echo "FFMPEG_DIR=$vcpkgInstalled" >> $env:GITHUB_ENV
          echo "INCLUDE=$vcpkgInstalled\include;$env:INCLUDE" >> $env:GITHUB_ENV
          echo "LIB=$vcpkgInstalled\lib;$env:LIB" >> $env:GITHUB_ENV
          echo "PKG_CONFIG=$vcpkgInstalled\tools\pkgconf\pkgconf.exe" >> $env:GITHUB_ENV
          echo "PKG_CONFIG_PATH=$vcpkgInstalled\lib\pkgconfig" >> $env:GITHUB_ENV
          echo "$vcpkgInstalled\bin" >> $env:GITHUB_PATH

      - name: Set up MSVC environment (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install chromaprint and FFmpeg (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install chromaprint ffmpeg pkg-config
          prefix="$(brew --prefix chromaprint)"
          echo "PKG_CONFIG_PATH=${prefix}/lib/pkgconfig" >> $GITHUB_ENV
          echo "LIBRARY_PATH=${prefix}/lib" >> $GITHUB_ENV
          echo "DYLD_LIBRARY_PATH=${prefix}/lib" >> $GITHUB_ENV
          pkg-config --cflags --libs libchromaprint
          ls -l ${prefix}/lib | grep chromaprint || true

      - name: Install chromaprint and FFmpeg (Ubuntu)
        if: runner.os == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ffmpeg \
            libavcodec-dev libavdevice-dev libavformat-dev libavutil-dev libavfilter-dev libswresample-dev libswscale-dev \
            libchromaprint-dev pkg-config
          echo "PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig" >> $GITHUB_ENV
          echo "LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:/usr/lib" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:/usr/lib" >> $GITHUB_ENV
          pkg-config --cflags --libs libchromaprint
          ls -l /usr/lib/x86_64-linux-gnu/libchromaprint* || true

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Build
        shell: pwsh
        run: |
          if ($IsWindows) {
            # Run cargo through MSVC environment for Windows
            $vsPath = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise"
            if (-not (Test-Path $vsPath)) {
              $vsPath = "C:\Program Files\Microsoft Visual Studio\2022\Community"
            }
            $vcvarsPath = "$vsPath\VC\Auxiliary\Build\vcvars64.bat"
            $env:CC = "cl.exe"
            $env:CXX = "cl.exe"
            
            # Invoke vcvars and build in one command
            cmd /c "`"$vcvarsPath`" && cargo build --workspace --all-targets --locked"
          } else {
            cargo build --workspace --all-targets --locked
          }

      - name: Clippy (deny warnings)
        shell: pwsh
        run: |
          if ($IsWindows) {
            $vsPath = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise"
            if (-not (Test-Path $vsPath)) {
              $vsPath = "C:\Program Files\Microsoft Visual Studio\2022\Community"
            }
            $vcvarsPath = "$vsPath\VC\Auxiliary\Build\vcvars64.bat"
            cmd /c "`"$vcvarsPath`" && cargo clippy --workspace --all-targets -- -D warnings"
          } else {
            cargo clippy --workspace --all-targets -- -D warnings
          }

      - name: Tests
        shell: pwsh
        run: |
          if ($IsWindows) {
            $vsPath = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise"
            if (-not (Test-Path $vsPath)) {
              $vsPath = "C:\Program Files\Microsoft Visual Studio\2022\Community"
            }
            $vcvarsPath = "$vsPath\VC\Auxiliary\Build\vcvars64.bat"
            cmd /c "`"$vcvarsPath`" && cargo test --workspace --all-features --all-targets"
          } else {
            cargo test --workspace --all-features --all-targets
          }

      - name: Run and check (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          export RUST_LOG=info
          export CHORROSION_DATABASE__URL="sqlite://data/chorrosion.db"
          # Run compiled binary directly to avoid cargo keeping control of the process
          target/debug/chorrosion-cli &
          SERVER_PID=$!

          # Wait for health to be ready
          health_ok=false
          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:5150/health | grep -q '"status":"ok"'; then
              echo "health ok"
              health_ok=true
              break
            fi
            sleep 1
          done

          if [ "$health_ok" != true ]; then
            echo "Health check failed after 30 seconds"
            kill "$SERVER_PID" || true
            wait "$SERVER_PID" || true
            exit 1
          fi

          # Verify OpenAPI JSON served (store in variable to avoid SIGPIPE from head -c 1)
          if ! openapi_response=$(curl -fsS http://127.0.0.1:5150/api-doc/openapi.json); then
            echo "Failed to fetch OpenAPI JSON"
            kill "$SERVER_PID" || true
            wait "$SERVER_PID" || true
            exit 1
          fi
          if ! printf '%s' "$openapi_response" | head -c 1 | grep -q '{'; then
            echo "OpenAPI JSON check failed"
            kill "$SERVER_PID" || true
            wait "$SERVER_PID" || true
            exit 1
          fi

          # Stop server
          kill "$SERVER_PID" || true
          wait "$SERVER_PID" || true

      - name: Run and check (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $env:RUST_LOG = 'info'
          $env:CHORROSION_DATABASE__URL = 'sqlite://data/chorrosion.db'

          $exe = Join-Path $PWD 'target\debug\chorrosion-cli.exe'
          if (-not (Test-Path $exe)) { throw "Binary not found: $exe" }

          $p = Start-Process -FilePath $exe -PassThru
          try {
            $ok = $false
            for ($i=0; $i -lt 30; $i++) {
              try {
                $r = Invoke-RestMethod -Uri http://127.0.0.1:5150/health -TimeoutSec 2
                if ($r.status -eq 'ok') { $ok = $true; break }
              } catch {
                Start-Sleep -Seconds 1
              }
            }
            if (-not $ok) { throw "Health check failed" }

            $resp = Invoke-WebRequest -Uri http://127.0.0.1:5150/api-doc/openapi.json -TimeoutSec 5
            if (-not ($resp.Content.Trim().StartsWith('{'))) { throw "OpenAPI JSON not found" }
          } finally {
            Stop-Process -Id $p.Id -Force -ErrorAction SilentlyContinue
          }

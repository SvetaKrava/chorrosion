name: CI Smoke

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ "**" ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  smoke:
    name: Smoke (build, lint, test, run)
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Install chromaprint and FFmpeg (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Install LLVM and 7-Zip using winget (recommended)
          # If winget fails, use choco as fallback
          winget install llvm.llvm -e
          winget install 7zip.7zip -e

          $ffmpegRoot = "C:\ffmpeg"
          $ffmpegShared = "$ffmpegRoot\shared"
          New-Item -ItemType Directory -Force -Path $ffmpegShared | Out-Null

          $ffmpegSharedUrl = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-full-shared.7z"
          Invoke-WebRequest -Uri $ffmpegSharedUrl -OutFile "$ffmpegRoot\ffmpeg-shared.7z"
          7z x "$ffmpegRoot\ffmpeg-shared.7z" -o"$ffmpegShared" -y | Out-Null

          $ffmpegSharedDir = Get-ChildItem -Path $ffmpegShared -Directory | Select-Object -First 1
          if (-not $ffmpegSharedDir) { throw "FFmpeg extraction failed" }

          vcpkg install chromaprint:x64-windows
          vcpkg install ffmpeg[avcodec,avdevice,avformat,avfilter,swresample,swscale]:x64-windows
          $vcpkgRoot = $env:VCPKG_INSTALLATION_ROOT
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV
          echo "VCPKG_ROOT=$vcpkgRoot" >> $env:GITHUB_ENV
          echo "VCPKG_DEFAULT_TRIPLET=x64-windows" >> $env:GITHUB_ENV
          echo "FFMPEG_DIR=$($ffmpegSharedDir.FullName)" >> $env:GITHUB_ENV
          echo "INCLUDE=$vcpkgRoot\installed\x64-windows\include;$env:INCLUDE" >> $env:GITHUB_ENV
          echo "LIB=$vcpkgRoot\installed\x64-windows\lib;$env:LIB" >> $env:GITHUB_ENV
          echo "PKG_CONFIG=$vcpkgRoot\installed\x64-windows\tools\pkgconf\pkgconf.exe" >> $env:GITHUB_ENV
          echo "PKG_CONFIG_PATH=$vcpkgRoot\installed\x64-windows\lib\pkgconfig" >> $env:GITHUB_ENV
          echo "$($ffmpegSharedDir.FullName)\bin" >> $env:GITHUB_PATH
          echo "$vcpkgRoot\installed\x64-windows\bin" >> $env:GITHUB_PATH

      - name: Install chromaprint and FFmpeg (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install chromaprint ffmpeg pkg-config
          prefix="$(brew --prefix chromaprint)"
          echo "PKG_CONFIG_PATH=${prefix}/lib/pkgconfig" >> $GITHUB_ENV
          echo "LIBRARY_PATH=${prefix}/lib" >> $GITHUB_ENV
          echo "DYLD_LIBRARY_PATH=${prefix}/lib" >> $GITHUB_ENV
          pkg-config --cflags --libs libchromaprint
          ls -l ${prefix}/lib | grep chromaprint || true

      - name: Install chromaprint and FFmpeg (Ubuntu)
        if: runner.os == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ffmpeg \
            libavcodec-dev libavdevice-dev libavformat-dev libavutil-dev libavfilter-dev libswresample-dev libswscale-dev \
            libchromaprint-dev pkg-config
          echo "PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:/usr/share/pkgconfig" >> $GITHUB_ENV
          echo "LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:/usr/lib" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:/usr/lib" >> $GITHUB_ENV
          pkg-config --cflags --libs libchromaprint
          ls -l /usr/lib/x86_64-linux-gnu/libchromaprint* || true

      - name: Cache Cargo
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Build
        run: cargo build --workspace --all-targets --locked

      - name: Clippy (deny warnings)
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Tests
        run: cargo test --workspace --all-features --all-targets

      - name: Run and check (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          export RUST_LOG=info
          export CHORROSION_DATABASE__URL="sqlite://data/chorrosion.db"
          # Run compiled binary directly to avoid cargo keeping control of the process
          target/debug/chorrosion-cli &
          SERVER_PID=$!

          # Wait for health to be ready
          health_ok=false
          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:5150/health | grep -q '"status":"ok"'; then
              echo "health ok"
              health_ok=true
              break
            fi
            sleep 1
          done

          if [ "$health_ok" != true ]; then
            echo "Health check failed after 30 seconds"
            kill "$SERVER_PID"
            wait "$SERVER_PID" || true
            exit 1
          fi

          # Verify OpenAPI JSON served
          if ! curl -fsS http://127.0.0.1:5150/api-doc/openapi.json | head -c 1 | grep -q '{'; then
            echo "OpenAPI JSON check failed"
            kill "$SERVER_PID"
            wait "$SERVER_PID" || true
            exit 1
          fi

          # Stop server
          kill $SERVER_PID
          wait $SERVER_PID || true

      - name: Run and check (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $env:RUST_LOG = 'info'
          $env:CHORROSION_DATABASE__URL = 'sqlite://data/chorrosion.db'

          $exe = Join-Path $PWD 'target\debug\chorrosion-cli.exe'
          if (-not (Test-Path $exe)) { throw "Binary not found: $exe" }

          $p = Start-Process -FilePath $exe -PassThru
          try {
            $ok = $false
            for ($i=0; $i -lt 30; $i++) {
              try {
                $r = Invoke-RestMethod -Uri http://127.0.0.1:5150/health -TimeoutSec 2
                if ($r.status -eq 'ok') { $ok = $true; break }
              } catch {
                Start-Sleep -Seconds 1
              }
            }
            if (-not $ok) { throw "Health check failed" }

            $resp = Invoke-WebRequest -Uri http://127.0.0.1:5150/api-doc/openapi.json -TimeoutSec 5
            if (-not ($resp.Content.Trim().StartsWith('{'))) { throw "OpenAPI JSON not found" }
          } finally {
            Stop-Process -Id $p.Id -Force -ErrorAction SilentlyContinue
          }
